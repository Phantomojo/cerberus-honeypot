import os
import time
import shutil
import logging
import subprocess
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler

# WHY THIS FIX: In Phase III, the honeypot must do more than just record commands.
# It must autonomously capture and analyze the tools attackers bring into the environment.
# This watchdog ensures that no payload is lost and every byte is analyzed for "Malware DNA."

WATCH_DIR = "services/cowrie/dl"
QUARANTINE_DIR = "quarantine"
LOG_FILE = "logs/malware_analysis.log"

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s [MALWARE_LAB] %(message)s',
    handlers=[
        logging.FileHandler(LOG_FILE),
        logging.StreamHandler()
    ]
)

class MalwareHandler(FileSystemEventHandler):
    def on_created(self, event):
        if event.is_directory:
            return

        src_path = event.src_path
        filename = os.path.basename(src_path)
        timestamp = int(time.time())
        dest_path = os.path.join(QUARANTINE_DIR, f"{timestamp}_{filename}")

        logging.info(f"üö® NEW PAYLOAD CAPTURED: {filename}")

        # Give Cowrie a second to finish writing the file
        time.sleep(1)

        try:
            # 1. QUARANTINE
            shutil.copy2(src_path, dest_path)
            logging.info(f"[‚úì] Quarantined to: {dest_path}")

            # 2. ANALYSIS
            self.analyze(dest_path)

        except Exception as e:
            logging.error(f"[‚úó] Failed to process {filename}: {e}")

    def analyze(self, file_path):
        """Perform rapid autonomous analysis on the payload."""
        logging.info(f"[*] Starting Autonomous Analysis on {file_path}...")

        # Get basic file info
        file_type = subprocess.getoutput(f"file {file_path}")
        file_size = os.path.getsize(file_path)

        logging.info(f"    - Type: {file_type}")
        logging.info(f"    - Size: {file_size} bytes")

        # Look for suspicious strings (IPs, URLs, Shell commands)
        strings_cmd = f"strings {file_path} | grep -E 'http|uuid|/bin/sh|chmod' | head -n 10"
        malware_dna = subprocess.getoutput(strings_cmd)

        if malware_dna:
            logging.warning(f"    - MALWARE DNA DETECTED:\n{malware_dna}")
        else:
            logging.info("    - No immediate shell/URL markers found.")

if __name__ == "__main__":
    if not os.path.exists(QUARANTINE_DIR):
        os.makedirs(QUARANTINE_DIR)

    if not os.path.exists(WATCH_DIR):
        os.makedirs(WATCH_DIR)

    event_handler = MalwareHandler()
    observer = Observer()
    observer.schedule(event_handler, WATCH_DIR, recursive=False)

    logging.info(f"üõ°Ô∏è Cerberus Malware Lab active. Watching {WATCH_DIR}...")

    observer.start()
    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        observer.stop()
    observer.join()
