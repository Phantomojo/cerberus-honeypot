name: CI - Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc make

    - name: Build project
      run: make all

    - name: Run tests
      run: |
        echo "=== Running State Engine Tests ==="
        ./build/state_engine_test
        echo ""
        echo "=== Running Morph Tests ==="
        ./tests/test_morph.sh || true
        echo ""
        echo "=== Running Quorum Tests ==="
        ./tests/test_quorum.sh || true

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          build/morph
          build/quorum
          build/state_engine_test
        retention-days: 7

  build-debug:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc make

    - name: Build with debug/sanitizers
      run: make debug

    - name: Run tests with sanitizers
      run: |
        ./build/state_engine_test
      env:
        ASAN_OPTIONS: detect_leaks=1:abort_on_error=1
        UBSAN_OPTIONS: print_stacktrace=1:abort_on_error=1
