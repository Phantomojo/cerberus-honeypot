name: Security Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Install analysis tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck flawfinder

    - name: Run cppcheck
      run: |
        echo "=== Running cppcheck ==="
        cppcheck --enable=all \
                 --suppress=missingIncludeSystem \
                 --error-exitcode=0 \
                 --xml \
                 --xml-version=2 \
                 src/ include/ 2> cppcheck-report.xml || true
        cppcheck --enable=all \
                 --suppress=missingIncludeSystem \
                 src/ include/

    - name: Run flawfinder
      run: |
        echo "=== Running flawfinder (Security-focused) ==="
        flawfinder --minlevel=1 --html > flawfinder-report.html src/ include/ || true
        flawfinder --minlevel=2 src/ include/

    - name: Upload analysis reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          cppcheck-report.xml
          flawfinder-report.html
        retention-days: 30

  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Check for hardcoded secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ""
        extra_args: --only-verified

  memory-safety:
    name: Memory Safety Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc make valgrind

    - name: Build with debug symbols
      run: |
        make clean
        CFLAGS="-g -O0" make all

    - name: Run Valgrind memcheck
      run: |
        echo "=== Running Valgrind Memory Check ==="
        valgrind --leak-check=full \
                 --show-leak-kinds=all \
                 --track-origins=yes \
                 --error-exitcode=0 \
                 ./build/state_engine_test 2>&1 | tee valgrind-report.txt

    - name: Upload Valgrind report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: valgrind-report
        path: valgrind-report.txt
        retention-days: 30

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Check for license headers
      run: |
        echo "=== Checking for files without license headers ==="
        find src include -name "*.c" -o -name "*.h" | while read file; do
          if ! head -20 "$file" | grep -qi "license\|copyright\|SPDX"; then
            echo "WARNING: No license header found in $file"
          fi
        done
